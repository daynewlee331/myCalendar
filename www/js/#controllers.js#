angular.module('starter.controllers', ['ngCordova'])
.controller('DashCtrl', function($scope, $http) {
  
})

.controller('exhCtrl', function($scope, $http) {
  $http.get('lib/data.json').success(function(data){
    var json = data;
    var i = 0;
    var myDiv = "";
    while(i < json.length){
      var date = json[i]['date'][0];
      var info = json[i]['info'][0];
      var name = json[i]['name'][0];
      var regex = /(&nbsp;|<([^>]+)>)/ig
	  ,   body = name
	  ,   exhName = body.replace(regex, "");
      var regex = /(&nbsp;|<([^>]+)>)/ig
          ,   body = info
          ,   exhInfo = body.replace(regex, "").trim();
      if(date != null){
       var arr = exhInfo.split(' ');
       var location = arr[0];
       var website = arr[arr.length - 1];
       myDiv = myDiv + "<div class=\"item item-body\"><h2>"+exhName.trim()+"</h2><h3>"+location+"<br>"+website+"</h3><p>"+date+"</p></div>";
      }
      i++;  
    }
    document.getElementById("exh").innerHTML = myDiv;
  }); 
})

.controller('panelCtrl', function($scope, $ionicLoading, zipCode, $injector) {

	$scope.loadingIndicator = $ionicLoading.show({
		content: 'Loading Data',
		animation: 'fade-in',
		showBackdrop: false,
		maxWidth: 200,
		showDelay: 500
	    });
 	   
  zipCode.then(function(response){
   
	  //document.getElementById("locationName").innerHTML=response.data.city;
    window.localStorage.setItem("city", response.data.city);
    var city = response.data.city;
    var cCode = response.data.countryCode;
     
    $injector.invoke(function($http) {
      var url = "http://openapi.baidu.com/public/2.0/bmt/translate?client_id=1AChyy77qsPGxvNeUewV9QfB&q="+city+"&from=en&to=zh&callback=JSON_CALLBACK";
      $http.jsonp(url).success(function(data){
	var response = data.trans_result[0]['dst'];
	document.getElementById("locationName").innerHTML=response;
      })

    })

    $injector.invoke(function($http) {
      var pic = "http://image.baidu.com/i?tn=baiduimagejson&ct=201326592&cl=2&lm=-1&st=-1&fm=result&fr=&sf=1&fmq=1349413075627_R&pv=&ic=0&nc=1&z=&se=1&showtab=0&fb=0&width=&height=&face=0&istype=2&word="+ city  +"&rn=2&pn=1&callback=JSON_CALLBACK";
      $http.jsonp(pic).success(function(data){
	var picUrl = data.data[0]['objURL'];
        document.getElementById("locationImg").innerHTML='';
        document.getElementById("locationImg").innerHTML="<img src=\"" + picUrl + "\" id='cityImg'>";
      })
    })

    )
	.success(function(response) {
          $scope.names = response.records;
        });
    })
   
	//display current date
    $injector.invoke(function($http) {  
      var url = "http://api.k780.com:88/?app=life.time&appkey=13965&sign=179b45462a6136b4073aaba7187529dc&format=json&jsoncallback=JSON_CALLBACK";  
      $http.jsonp(url).success(function(data){
	      //      alert(data);
	if(data['success'] == 1){
	  var date = data['result']['datetime_2'].split(' ')[0];
          var week = data['result']['week_2'];
          document.getElementById("date").innerHTML= date + " " + week;
        }

      })
    })
    
    //weather forecast
    $injector.invoke(function($http) {  
	    var url = "http://api.k780.com:88/?app=weather.future&weaid=1&appkey=13965&sign=179b45462a6136b4073aaba7187529dc&format=json&jsoncallback=JSON_CALLBACK&weaid="+city.toLowerCase();
      $http.jsonp(url).success(function(data){
	      //alert(data);
	if(data['success'] == 1){
	  var list = data['result'];
          var icon = list[0]['weather_icon'];
          var temp = list[0]['temperature'];
          var weather = list[0]['weather'];
          document.getElementById("weather").innerHTML= "<img src=\""+icon+"\" id='wIcon'>" + "<h2 id = 'temp'>" + weather + "</h2><p id = 'temp'> " + temp  + "</p>"; 
          var i = 1;
          while(i < list.length){
	    var element = list[i];
            var icon = element['weather_icon'];
	    var temp = element['temperature'];
	    var weather = element['weather'];
            var day = element['week'];
            document.getElementById("day"+(i-1)).innerHTML="<img src=\""+icon+"\" id='wIcon'>" + "<h2>" + temp +"</h2>" + "<p>" + day  + "</p>";
	    i ++;
          }
        }
	  })
          $ionicLoading.hide();
	  })
	  })
      })

.controller('SaveCtrl', function($scope, zipCode) {
  $scope.save = function(){
    var text = document.getElementById("notes").value;
    if(text != window.localStorage['notes']){
      window.localStorage['notes'] = null;
      window.localStorage['notes'] = text;
      document.getElementById("alert").innerHTML = "<button class=\"button button-full button-balanced\">’ÊÝ’Â¸’À®’¸ù</button>";
      setTimeout(function(){ document.getElementById("alert").innerHTML =""; }, 1000);
    }  
  }
})

.controller('AccountCtrl', function($scope) {
  $scope.settings = {
    enableFriends: true
  };
})

.controller('noteCtrl', function($scope, zipCode) {
	if(window.localStorage['notes'] != null && window.localStorage['notes'] != ""){
	    //document.getElementById("notes").innerHTML = window.localStorage['notes'];
            //$scope.notes = window.localStorage['notes'];
            $scope.model = window.localStorage['notes'];
	}
    });